import asyncio
import json
import requests
import os
from openai import OpenAI

from kafka import KafkaConsumer, KafkaProducer
from bs4 import BeautifulSoup
from urllib.request import urlopen
import asyncio
from playwright.async_api import async_playwright


consumer = KafkaConsumer(
    'LlmRequest',
    bootstrap_servers='kafka:9092',
    value_deserializer=lambda m: json.loads(m.decode('utf-8')),
    auto_offset_reset='earliest',
    enable_auto_commit=True,
    group_id='integration-group'
)

producer = KafkaProducer(bootstrap_servers='kafka:9092')

def ask_deepseek(prompt: str, system_prompt: str, api_key: str = None) -> str:
    api_key = api_key or os.getenv("DEEPSEEK_API_KEY", "sk-e46b5fda16bd40d8934ce29ff0f2e7c1")

    client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")

    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt},
        ],
        temperature=0.4,
        stream=False
    )

    return response.choices[0].message.content

def get_web_urls(search_term: str, num_results: int = 10) -> list[str]:
    api_key = "AIzaSyBEpWkmsABdw1NepnqA6SZXIsoyhrQ3T7M"
    cx = "92d7e7e5b521d4c7e"

    # –£–¥–∞–ª—è–µ–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    discard_urls = ["youtube.com", "britannica.com", "vimeo.com", "vk.com", "bbc.com", "24tv.ua", "instagram.com"]
    excluded_sites = " ".join(f"-site:{site}" for site in discard_urls)
    query = f"{search_term} {excluded_sites}"

    urls = []
    start_index = 1

    while len(urls) < num_results:
        params = {
            "key": api_key,
            "cx": cx,
            "q": query,
            "start": start_index,
        }

        response = requests.get("https://www.googleapis.com/customsearch/v1", params=params)
        data = response.json()

        items = data.get("items", [])
        if not items:
            break

        for item in items:
            urls.append(item["link"])
            if len(urls) >= num_results:
                break

        start_index += 10

    return urls

async def generate_image(prompt_text: str) -> str:
    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=True,
            args=[
                "--no-sandbox",
                "--disable-gpu",
                "--disable-dev-shm-usage",
                "--disable-setuid-sandbox"
            ]
        )
        page = await browser.new_page()

        await page.goto("https://ai-girl.site/flux-ai-image-generator")

        await page.wait_for_selector('input[data-testid="textbox"]', timeout=15000)
        await page.wait_for_timeout(3000)

        await page.fill('input[data-testid="textbox"]', prompt_text)
        await page.click('button#component-5')

        await page.wait_for_selector('img.svelte-1pijsyv[src*="/file=/"]', timeout=120000)
        img_element = await page.query_selector('img.svelte-1pijsyv[src*="/file=/"]')
        img_src = await img_element.get_attribute('src')

        await browser.close()
        return img_src

def fetch_clean_text(url: str, timeout: int = 3) -> str:
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        f = urlopen(url, timeout=timeout)
        html = f.read()

        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É (HTML)
        html_content = html.decode("utf-8")

        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç BeautifulSoup –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
        soup = BeautifulSoup(html_content, features="html.parser")

        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–µ–≥–∏ script –∏ style
        for script in soup(["script", "style"]):
            script.extract()  # –£–±–∏—Ä–∞–µ–º –∏—Ö –∏–∑ –¥–µ—Ä–µ–≤–∞

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç
        text = soup.get_text()

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –∏ —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        lines = (line.strip() for line in text.splitlines())
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
        chunks = (phrase.strip() for line in lines for phrase in line.split("  "))

        # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        clean_text = '\n'.join(chunk for chunk in chunks if chunk)

        print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω —Ç–µ–∫—Å—Ç —Å URL: {url}")

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–≤—ã–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤)
        return clean_text[:5000]

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {url}: {e}")
        return ""

async def handle_prompt(prompt, chatUuid, needImages):
    print('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é prompt')
    web_urls = get_web_urls(prompt)  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ URL-–æ–≤
    print(web_urls)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    results = []

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ URL –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    for url in web_urls:
        markdown = fetch_clean_text(url=url)  # –ü–æ–ª—É—á–∞–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
        if markdown:
            results.append({
                "url": url,
                "markdown": markdown
            })

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
    sources = ""
    for result in results:
        if result["markdown"]:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ URL –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É
            sources += f"üìÑ Full content from {result['url']}:\n"
            sources += result["markdown"] + "\n\n"

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ 56,000 —Å–∏–º–≤–æ–ª–∞–º–∏
    sources = sources[:56000]

    system_prompt = f"""
    –¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç WhatIF, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∫–ª—é—á–µ–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π –†–æ—Å—Å–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ <{sources}> –∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ω–∏—Ö. –í—Å–µ–≥–¥–∞ –ø–∏—à–∏, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç–æ–±–æ–π. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –∑–∞–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏–π, —Ç–æ–≥–¥–∞ –Ω–∞–¥–æ –æ—Ç–≤–µ—á–∞—Ç—å, —á—Ç–æ —Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏—è—Ö

    –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã:
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç–≤–µ—Ç–∞
    –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –Ω–µ –ø—Ä–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ç—Ä–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–æ—Å—Å–∏–∏, —Ç–æ–≥–¥–∞ –Ω–∞–¥–æ –æ—Ç–≤–µ—Ç–∏—Ç—å '–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–æ—Å—Å–∏–∏' –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤—ã–≤–æ–¥–∏—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
    
    –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –ø—Ä–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–æ—Å—Å–∏–∏, –Ω–æ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å—É <{prompt}>, –æ—Ç–≤–µ—Ç—å:
    ¬´–ü–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏—Å—å –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã.¬ª
    –ó–∞—Ç–µ–º –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–ª–µ–¥—É—é—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (—É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω—É–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±—ã–ª–æ –º–∞–ª–æ) –∏ –Ω–∏—á–µ–≥–æ –±–æ–ª—å—à–µ:
        1. –ù–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Ç–æ–≥ –±–µ–∑ –¥–∞–Ω–Ω–æ–≥–æ —É—Ç–æ—á–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
        2. –ù–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å
        3. –ù–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–≤–µ—Å—Ç–∏ –¥—Ä—É–≥–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ

    –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –ø—Ä–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–æ—Å—Å–∏–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –µ—Å—Ç—å, –Ω–æ –∫—Ä–∞–π–Ω–µ —Å–∫—É–¥–Ω–∞—è, —Ç–æ–∂–µ –Ω–∞–ø–∏—à–∏, —á—Ç–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏ –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏—Å—å.

    –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –ø—Ä–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–æ—Å—Å–∏–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –µ—Å—Ç—å –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–∞—è —Ç–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å:
    ¬´–ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –º–æ–≥–ª–∏ –∫–æ—Å–Ω—É—Ç—Å—è —Ä–æ—Å—Å–∏–∏¬ª (—ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–µ –∏–∑–º–µ–Ω–∏ –ø–æ–¥ –∫–æ–Ω—Ç–µ—Å—Ç)
    –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏ ¬´–ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ¬ª
    
    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

    –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º —Å–æ—Å—Ç–∞–≤–ª—è–π –æ—Ç–≤–µ—Ç, –Ω–∞–¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º

    –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º –∏ –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–µ–≥–æ —ç—Ç–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ—Å—Ç–∞–≤–ª—è–ª–∏—Å—å:
    –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–∞—É—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∫–Ω–∏–≥–∏, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤
    —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∞–≤—Ç–æ—Ä—ã
    –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤–∏–∫–∏–ø–µ–¥–∏—è, —Ñ–æ—Ä—É–º—ã, –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

    –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –º–Ω–æ–≥–æ, —Ç–æ –ø–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –≤—ã—Å–æ–∫–∏–º –∏ —Å—Ä–µ–¥–Ω–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—è –ø–æ–ª–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–∏—Ö

    –¢–µ–±–µ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö 5-7 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –Ω–∞ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç –∏–¥–µ—Ç –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –≤—ã–¥–∞–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞:

    1. –Ω–∞–ø–∏—Å–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–≥ '###'
    
    2. –ê–≤—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)

    3. –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏/–∫–Ω–∏–≥–∏/–¥–æ–∫—É–º–µ–Ω—Ç–∞

    4. –ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)

    5. –ü—Ä—è–º—É—é —Å—Å—ã–ª–∫—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–ª–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏ –±—ã–ª–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞–ø—Ä–∏–º–µ—Ä –µ—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –±—ã–ª–∞ —Å—Å—ã–ª–∫–∞: www.example.com/articles/1 —Ç–æ–≥–¥–∞ –Ω–∞–¥–æ —É–∫–∞–∑–∞—Ç—å www.example.com/articles/1) -> –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–≤—ã—Å–æ–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –Ω–∏–∑–∫–∏–π)

    6. –û–±–æ–±—â–µ–Ω–Ω–∞—è —Ç–æ–±–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –ø—Ä–æ —Å–æ–±—ã—Ç–∏–µ –≤ –¥–∞–Ω–Ω–æ–º –ø—É–Ω–∫—Ç–µ, –∫–æ—Ç–æ—Ä—É—é —Ç—ã –Ω–∞–ø–∏—Å–∞–ª (—Ä–∞—Å–ø–∏—Å—ã–≤–∞–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ, –Ω–æ —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
    
    7. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∑—è—Ç–∞ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–±–∑–∞—Ü–∞, —É–∫–∞–∂–∏ —ç—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ—Ç—å–µ–º—É –∞–±–∑–∞—Ü—É —Ä–∞–∑–¥–µ–ª–∞ "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è" –≤ —Å—Ç–∞—Ç—å–µ –ò–≤–∞–Ω–æ–≤–∞ (2010)‚Ä¶¬ª). –∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown –ø–æ–º–µ—á–∞—Ç—å —Ç–∞–∫–∏–º —Ç–µ–≥–æ–º: '>'
    –í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫ 5 –ø—É–Ω–∫—Ç—É –µ—Å–ª–∏ —Ç—ã –±–µ—Ä–µ—à—å –∫–∞–∫—É—é-–ª–∏–±–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π –∞–±–∑–∞—Ü –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ—Ç–∫—É–¥–∞ —Ç—ã —ç—Ç–æ –≤–∑—è–ª
    
    8. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏ —Ü–∏—Ç–∞—Ç—É –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø–æ —Ç–∞–∫–æ–º—É –ø—Ä–∏–º–µ—Ä—É: ¬´–°–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ—Ç—å–µ–º—É –∞–±–∑–∞—Ü—É —Ä–∞–∑–¥–µ–ª–∞ "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è" –≤ —Å—Ç–∞—Ç—å–µ –ò–≤–∞–Ω–æ–≤–∞ (2010)‚Ä¶¬ª –∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown –ø–æ–º–µ—á–∞—Ç—å —Ç–∞–∫–∏–º —Ç–µ–≥–æ–º: '>'
    –í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫ 6 –ø—É–Ω–∫—Ç—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–ª –æ—Ç–∫—É–¥–∞ –±—ã–ª–∞ –≤–∑—è—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

    –í–æ—Ç –ø—Ä–∏–º–µ—Ä –æ–¥–Ω–æ –∏–∑ –ø—É–Ω–∫—Ç–æ–≤ –∏ –µ–≥–æ markdown —Ñ–æ—Ä–º–∞—Ç:
    ----------------------------------------------
    ### –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞. –ó–∞–≥–æ–ª–æ–≤–æ–∫
    **–ê–≤—Ç–æ—Ä:**
    **–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏:**
    **–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:**
    **–°—Å—ã–ª–∫–∞:** [https://example.com/articles/1](https://example.com/articles/1)
    **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**

    > ¬´–¶–∏—Ç–∞—Ç–∞¬ª

    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
    ----------------------------------------------

    –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã –≤—ã–ø–∏—Å–∞–ª –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É –¥–∞–ª–µ–µ —Ç–µ–±–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —Å–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ —Å—Ç—Ä–æ–≥–æ –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ, –Ω–∞–ø–∏—Å–∞—Ç—å —Ç—É—Ç –Ω–∞–¥–æ –º–Ω–æ–≥–æ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ, —É—Å–ª–æ–≤–Ω—ã–µ –¥–∞—Ç—ã, –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–≤–∏—Ç–∏—è, —Å–∞–º–∏ —Å–æ–±—ã—Ç–∏—è –∏ —Ü–∏—Ç–∞—Ç—ã –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ—Ç–∫—É–¥–∞ —Ç—ã –±—Ä–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
    ### –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Ö–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏:
    1. **–¥–∞—Ç—ã:** –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    2. **–¥–∞—Ç—ã:** –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    ...

    –î–∞–ª–µ–µ –Ω–∞–¥–æ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Ç–µ–º —á—Ç–æ –º–æ–≥–ª–æ –±—ã –±—ã—Ç—å —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å
    
    –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –Ω—É–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
    ### –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    > **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:** –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∏–π
    ---
    ##### 1. –ê–≤—Ç–æ—Ä ‚Äî *–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏*
    —Ü–∏—Ç–∞—Ç–∞ –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    [https://example.com/articles/1](https://example.com/articles/1)  
    *–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:* –í—ã—Å–æ–∫–∏–π/—Å—Ä–µ–¥–Ω–∏–π/–Ω–∏–∑–∫–∏–π.

    –ö–∞–∂–¥—ã–π –∏–∑ —ç—Ç–∏—Ö –ø—É–Ω–∫—Ç–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∏ –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
    
    –ó–∞–ø—Ä–µ—â–µ–Ω–æ

    1. –î–æ–¥—É–º—ã–≤–∞—Ç—å –∏–ª–∏ –¥–æ–º—ã—Å–ª–∏–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã.
    2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    3. –î–∞–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏.
    """

    photo_generation_prompt = """
        –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 1 –ø—Ä–æ–º–ø—Ç –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:
        1. –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç <–ü–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.> –∏–ª–∏ <–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–æ —è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö> —Ç–æ–≥–¥–∞ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        2. –í –∏–Ω–æ–º —Å–ª—É—á–∞–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π 1 –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∑–∞–ø—Ä–æ—Å–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.
        """

    #print(system_prompt)

    response = ask_deepseek(prompt=prompt, system_prompt=system_prompt)
    producer.send('LlmResponse', json.dumps({
        'chatUuid': chatUuid,
        'content': response,
        'type': 'LlmResponse'
    }).encode('utf-8'))

    if (needImages):
        image_prompt = ask_deepseek(prompt=response, system_prompt=photo_generation_prompt)
        print("Image promt", image_prompt)
        photo_url = await generate_image(image_prompt)
        photo_urls = [photo_url]
         # –∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö
        print("Photot urls:", photo_urls)
        producer.send(
            'LlmResponse',
            json.dumps({
                'chatUuid': chatUuid,
                'type': 'LlmPhotoResponse',
                'urls': photo_urls
            }).encode('utf-8'))





def handle_image(prompt, chatUuid):
    print('–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é image')

async def process_messages():
    print("Kafka consumer started. Waiting for messages...")
    for message in consumer:
        prompt = message.value.get("content")
        chatUuid = message.value.get("chatUuid")
        needImages = message.value.get("needImages")
        print(needImages)
        #needImages = message.value.get("needImages")
        print("message ", message)
        #type = message.value.get("type")
        print(f"Received message for chatuuid: {chatUuid}: prompt: {prompt}")


        await handle_prompt(prompt, chatUuid, needImages)

        # match type:
        #     case "prompt":
        #         # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        #         await handle_prompt(prompt, chatUuid)
        #     case "image":
        #         # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        #         handle_image(prompt, chatUuid)
        #     case _:
        #         print(f"Unknown type: {type}")


        #response = "generated response using crawl4ai"


if __name__ == "__main__":
    asyncio.run(process_messages())